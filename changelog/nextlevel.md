# Next-Level Engineering Roadmap

> Objective: Transform this repository from a robust academic setup toolkit into a production-grade, reproducible, observable, secure, and continuously validated engineering platform.

---
## Guiding Principles
- Deterministic: Same inputs -> same environment.
- Idempotent + Recoverable: Re-runs cause no harm; state changes tracked and reversible.
- Observable: Every major action emits structured telemetry (machine + human readable).
- Secure-by-Default: Integrity verification, least-privilege, minimized supply-chain risk.
- Profiled: Tailored installation depth (minimal / standard / full / ci).
- Extensible: Pluggable modules with clear contracts (inputs/outputs, exit semantics).
- Documented from Source: Docs generated from canonical machine-readable manifests.

---
## Phase Overview (Sequential, Overlapping Allowed)
| Phase | Theme | Core Outcomes |
|-------|-------|--------------|
| 1 | Version Pinning & Manifests | versions.yaml, resolver, pin enforcement, generated tools matrix |
| 2 | CI & Automated Validation | GitHub Actions pipelines, smoke containers, shell lint gates |
| 3 | Security & Integrity | Checksum/GPG verification, SBOM, artifact allowlist, curl minimization |
| 4 | State, Rollback, Offline | Change ledger, rollback script, cache/prefetch layer, offline mode |
| 5 | Observability & Metrics | Structured logs, timing, resource usage, verification JSON export |
| 6 | Profiles & Modularity | --profile flags, task graph executor, plugin hooks |
| 7 | Performance & Parallelism | Batched installs, concurrency where safe, profiling reports |
| 8 | UX & Teaching Aids | Guided TUI, remediation suggestions, docs generation automation |
| 9 | Hardening & Drift Control | Drift detector CI job, auto-diff doc generator, stale pin alerts |
| 10 | Polishing & Ecosystem | Container images, SBOM diffing, release tagging, upgrade assistant |

---
## Detailed Deliverables by Phase
### Phase 1: Version Pinning & Manifests
Deliverables:
- `manifests/versions.yaml` (schema below)
- `scripts/utils/version-resolver.sh` (shell API: load_versions, get_version <key>)
- Replacement of ad-hoc `pip install X` with pinned spec sets aggregated into grouped install calls.
- Autogenerated `TOOLS_MATRIX.md` + injection section in `README.md` via `scripts/tools/generate-docs.sh`.
- Validation script `scripts/validation/verify-pins.sh` ensuring no unpinned critical installs remain.

versions.yaml schema (draft):
```yaml
schema_version: 1
python:
  required: ["3.11.7"]
  packages:
    core:
      numpy: "1.26.*"
      pandas: "2.2.*"
      matplotlib: "3.8.*"
    ml:
      torch: "2.2.*"
      torchvision: "0.17.*"
      tensorflow: { selector: "gpu|cpu", versions: { cpu: "2.16.*", gpu: "2.16.*" } }
node:
  runtime: "20.11.*"
  globals:
    - name: typescript
      version: "5.4.*"
    - name: yarn
      version: "1.22.*"
    - name: pnpm
      version: "8.15.*"
linux:
  apt:
    base:
      - build-essential=12.9ubuntu3
      - cmake=3.28.*
    db:
      - postgresql=16*
      - redis-server=7.0*
macos:
  brew:
    base:
      - cmake@3.28
      - jq
profiles:
  minimal:
    python.packages: ["core"]
  full:
    python.packages: ["core","ml"]
```

Acceptance Criteria:
- Running `generate-docs.sh` produces stable matrix diff only when versions.yaml changes.
- Scripts fail fast if resolver cannot map a requested component.

### Phase 2: CI & Automated Validation
Deliverables:
- `.github/workflows/ci.yml` with jobs:
  - lint (shellcheck, markdownlint)
  - static pin audit (verify-pins.sh)
  - smoke (ubuntu-latest, macos-latest): run minimal profile setups + verifications (timeouts enforced)
- Artifact upload: verification JSON summaries.
- Badge generation for README (Pass/Fail status link).
Acceptance Criteria:
- PR blocked unless all jobs succeed.
- CI runtime target: < 15m for full matrix (stretch: < 10m after Phase 7).

### Phase 3: Security & Integrity
Deliverables:
- `scripts/security/checksums.sh` with `verify_download <url> <sha256>`.
- Manifest extension: `sources:` block with URL + SHA256.

### Phase 3 Incremental Additions (Post Baseline)
- Added `gpg_keys:` manifest section and `verify-gpg-key.sh` to enforce repository signing key fingerprints (initial: Microsoft VS Code).
- Integrated GPG verification into VS Code setup script (Ubuntu/Deb/RPM paths) pre-repo registration.
- CI security-baseline job now produces `gpg_keys_report.json` and fails on placeholder/mismatch.
- SBOM generation: `scripts/security/generate-sbom.sh` (CycloneDX for pip/npm + manual system list) → `sbom/`.
- LICENSE aggregation script: detect distinct licenses, output `THIRD_PARTY_LICENSES.md`.
- Ban `curl | bash` patterns; enforce detached download + verify + execute.
- Archive integrity hardening: added `content_length` for all Eclipse archives, `verify-archives.sh` (quick/full), CI workflow `verify-archives.yml`.
- Release bump automation: `update-eclipse-release.sh` to reset Eclipse artifact hashes/sizes for new releases.
- Aggregated meta entry `eclipse-release-2025-09` for programmatic iteration over variants.
Acceptance Criteria:
- CI fails if any source referenced without checksum.
- SBOM diff job highlights new components.

### Phase 4: State, Rollback, Offline
Deliverables:
- `state/ledger.json` incremental append (JSON lines) with operation, timestamp, tool, action, success.
- `scripts/state/rollback.sh` stub (Phase 4 implements uninstall for subset: npm -g, pip user packages, simple apt/brew leaves; Phase 8 expands).
- Prefetch: `scripts/cache/prefetch.sh --profile full` populates `cache/` (wheels, npm tarballs, brew bundle).
- Offline mode flag `--offline` uses only cached artifacts; fails with actionable message if missing.
Acceptance Criteria:
- Killing a script mid-run leaves ledger consistent (use atomic append).
- Re-running with `--offline` works after a successful prefetch (no network calls observable in logs).

### Phase 5: Observability & Metrics
Deliverables:
- Structured JSON log emitter `scripts/utils/log-json.sh` (fields: ts, phase, action, duration_ms, status, error?).
- Wrap major phases with timing; write to `logs/last-run.jsonl` + optional `--log-dir` override.
- Verification summary gains `--output-json <file>` with PASS/FAIL list.
- Metrics aggregator `scripts/metrics/summarize.sh` outputs durations histogram + slowest 10 steps.
Acceptance Criteria:
- CI artifact includes metrics summary.
- All installs > outlier threshold flagged.

### Phase 6: Profiles & Modularity
Deliverables:
- Unified argument parsing library `scripts/utils/argparse.sh`.
- Profile dispatch table; each course script defers component selection to `profile_resolve <domain> <profile>`.
- Plugin system: `plugins/` directory; any `*.sh` with `plugin_register` function auto-sourced when `--enable-plugins` used.
Acceptance Criteria:
- Minimal profile reduces ML install (no heavy frameworks) & web (no Angular/Vue) while still verifying core.
- Adding a plugin file requires no changes to core scripts.

### Phase 7: Performance & Parallelism
Deliverables:
- Batching: consolidate pip installs per category (single invocation per group), apt multi-package lines, parallel safe groups via subshell + wait.
- Profiling mode `--profile-performance` prints concurrency graph & critical path.
- Caching improvements: pip wheel build reuse, Node `corepack enable` + deterministic installs.
Acceptance Criteria:
- Measured wall-clock reduction ≥ 25% vs Phase 1 baseline (documented in metrics history).

### Phase 8: UX & Teaching Aids
Deliverables:
- Interactive TUI (`gum` or fallback to plain prompts) for selecting profiles & optional components.
- Remediation generator: after verification failures, produce targeted install commands.
- `docs/generated/*.md` updated automatically (no manual edits in README sections between markers).
Acceptance Criteria:
- Choosing components interactively writes a reproducible invocation file (re-run later) e.g., `replay.sh`.

### Phase 9: Hardening & Drift Control
Deliverables:
- Drift detector: compares current system tool versions vs pinned; outputs actionable diff.
- Scheduled CI workflow (cron) that alerts on upstream version disappearance (e.g., brew formula rename) or security advisories (placeholder feed integration).
Acceptance Criteria:
- PR blocked if drift detector finds undocumented deltas.

### Phase 10: Polishing & Ecosystem
Deliverables:
- Official container images: `ghcr.io/<org>/dev-env:{minimal,full}` built from pinned manifests.
- Release automation: tag + changelog generation from ledger + commit conventional tags.
- Upgrade assistant: `scripts/upgrade/apply-migrations.sh` updates older clones to new manifest style.
Acceptance Criteria:
- Cutting a release requires only updating versions.yaml and running a single release script.

---
## Cross-Cutting Schemas
### Ledger Entry
```json
{
  "ts": "2025-09-15T12:34:56Z",
  "script": "setup-ml.sh",
  "action": "pip_install",
  "component": "numpy",
  "version": "1.26.2",
  "status": "success",
  "duration_ms": 3120,
  "profile": "full"
}
```

### Structured Log Event
```json
{
  "ts": "2025-09-15T12:35:02Z",
  "phase": "ml:tensorflow",
  "event": "install_start",
  "profile": "full",
  "attempt": 1
}
```

### Verification JSON Output
```json
{
  "script": "setup-database.sh",
  "profile": "full",
  "timestamp": "2025-09-15T12:40:00Z",
  "pass": ["psql","mysql","mongod","redis-server"],
  "fail": ["mysql_service"],
  "warn": ["mariadb_service"],
  "ports": {"5432": true, "3306": false}
}
```

---
## Task Matrix (Initial Population)
| ID | Phase | Category | Task | File(s) / Artifact | Est | Criticality |
|----|-------|----------|------|--------------------|-----|-------------|
| P1-1 | 1 | Manifest | Create `manifests/versions.yaml` | manifests/versions.yaml | 2h | High |
| P1-2 | 1 | Resolver | Implement `version-resolver.sh` | scripts/utils/version-resolver.sh | 3h | High |
| P1-3 | 1 | Refactor | Replace inline installs with resolver calls (db/web/ml/systems/mobile) | scripts/courses/*.sh | 1d | High |
| P1-4 | 1 | Docs | Doc generator + matrix injection | scripts/tools/generate-docs.sh | 4h | Medium |
| P1-5 | 1 | Guard | Pin audit script | scripts/validation/verify-pins.sh | 2h | High |
| P2-1 | 2 | CI | Add workflow (lint + smoke matrix) | .github/workflows/ci.yml | 3h | High |
| P2-2 | 2 | CI | Shellcheck + markdownlint config | .shellcheckrc, .markdownlint.json | 1h | Medium |
| P2-3 | 2 | CI | Upload verification artifacts | ci workflow | 1h | Medium |
| P3-1 | 3 | Security | checksums lib | scripts/security/checksums.sh | 2h | High |
| P3-2 | 3 | Security | Extend manifest (sources block + validation) | manifests/versions.yaml | 2h | High |
| P3-3 | 3 | Security | SBOM generation script | scripts/security/generate-sbom.sh | 4h | Medium |
| P3-4 | 3 | Security | Third-party license aggregator | scripts/security/licenses.sh | 3h | Medium |
| P4-1 | 4 | State | Ledger writer | scripts/state/ledger.sh | 3h | High |
| P4-2 | 4 | State | Rollback prototype | scripts/state/rollback.sh | 4h | Medium |
| P4-3 | 4 | Cache | Prefetch script | scripts/cache/prefetch.sh | 4h | High |
| P4-4 | 4 | Cache | Offline mode integration | shared scripts | 1d | High |
| P5-1 | 5 | Logs | JSON log emitter | scripts/utils/log-json.sh | 2h | High |
| P5-2 | 5 | Metrics | Summarize script | scripts/metrics/summarize.sh | 3h | Medium |
| P5-3 | 5 | Verify | Add --output-json to verification | scripts/utils/verify.sh | 1h | High |
| P6-1 | 6 | Profiles | argparse lib | scripts/utils/argparse.sh | 3h | High |
| P6-2 | 6 | Profiles | Profile resolution engine | scripts/utils/profile-resolver.sh | 4h | High |
| P6-3 | 6 | Profiles | Script integration | course scripts | 1d | High |
| P6-4 | 6 | Plugins | Plugin loader | scripts/utils/plugins.sh | 3h | Medium |
| P7-1 | 7 | Perf | Batch pip installs | course scripts | 4h | High |
| P7-2 | 7 | Perf | Parallel safe groups | course scripts | 6h | Medium |
| P7-3 | 7 | Perf | Performance profiling mode | scripts/utils/perf-profile.sh | 4h | Medium |
| P8-1 | 8 | UX | TUI selector | scripts/ux/select-profile.sh | 5h | Medium |
| P8-2 | 8 | UX | Remediation generator | scripts/ux/remediate.sh | 4h | Medium |
| P8-3 | 8 | Docs | Autogen section markers | generate-docs.sh | 2h | Medium |
| P9-1 | 9 | Drift | Drift detector | scripts/validation/drift-detect.sh | 4h | High |
| P9-2 | 9 | Drift | Scheduled workflow | .github/workflows/drift.yml | 1h | High |
| P10-1 | 10 | Release | Container Dockerfiles | docker/* | 1d | Medium |
| P10-2 | 10 | Release | Release automation script | scripts/release/create-release.sh | 4h | Medium |
| P10-3 | 10 | Release | Upgrade assistant | scripts/upgrade/apply-migrations.sh | 1d | Medium |

---
## Risk Register
| Risk | Impact | Mitigation |
|------|--------|------------|
| Upstream version removal | Breaks builds | Scheduled drift CI + mirrors |
| GPU lib conflicts | ML installs fail | Profile gating + isolated venv per heavy stack |
| Checksum rot (updated upstream tarballs) | False failure | Allow explicit rebaseline command |
| Parallel apt causing lock contention | Script abort | Detect apt lock; serialize critical phases |
| Offline cache staleness | Inconsistent env | Embed manifest hash in cache metadata |
| Plugin execution trust | Supply-chain risk | Signed plugin mode / allowlist directory |

---
## Acceptance Gate per Phase
- All deliverables merged + CI green
- Documentation updated/generated
- Metrics & validation evidence committed under `changelog/progress/`

---
## Initial Execution Order (Actionable Sprint Plan)
1. P1-1 → P1-2 → P1-5 (skeleton) to establish enforcement early.
2. P1-3 refactor incrementally per course script (commit per domain).
3. P1-4 finalize doc gen once refactors stabilize.
4. Move to Phase 2 CI gates immediately after first manifest-driven script lands.

---
## Next Immediate Step
Create `manifests/versions.yaml` + skeleton resolver + pin audit script (stubs) to anchor further work.

---
## Tracking & Progress
Progress snapshots appended here with timestamped mini-sections as work proceeds.

```
[2025-09-15T00:00Z] Roadmap initialized.
[2025-09-15T00:10Z] Phase 1 scaffolds created: manifests/versions.yaml, version-resolver skeleton, pin audit stub.
[2025-09-15T00:40Z] Manifest expanded with ML/Viz/NLP/CV groups + node globals; added data-science profile.
[2025-09-15T00:55Z] Resolver enhanced for dot-notation categories (extras.*) and nested group parsing.
[2025-09-15T01:10Z] Web development script refactored to manifest-driven global installs (removed ad-hoc extras loop).
[2025-09-15T01:25Z] Documentation generator script created (generate-docs.sh) and README markers inserted.
[2025-09-15T01:35Z] Pin audit script updated to tolerate resolver-driven variable installs; initial clean pass.
[2025-09-15T02:05Z] Added python web/db groups + mobile/web devtool node globals to manifest.
[2025-09-15T02:15Z] Refactored webdev & database scripts to resolver-driven pip installs (web/db groups).
[2025-09-15T02:25Z] Mobile script updated to manifest-driven global installs for RN/Expo/Appium/Detox.
[2025-09-15T02:30Z] Pin audit refined to whitelist new resolver patterns; docs matrix regenerated.
[2025-09-15T02:40Z] Refactored setup-eclipse with shared utils, safety flags, idempotent download.
[2025-09-15T02:45Z] Refactored setup-vscode with shared utils, idempotent extension installs.
[2025-09-15T03:05Z] Phase 2 CI expansion: added markdownlint config, docs consistency & smoke scripts, expanded workflow with matrix (ubuntu/macos) and artifacts, README badges inserted.
[2025-09-15T03:25Z] Phase 2 refinements completed (pin audit JSON output, reduced noise) and Phase 3 scaffolding added: sources block, checksum/SBOM/license stubs, CI security-stubs job, README security section updated.
[2025-09-15T03:45Z] Phase 3 baseline: added sources validation script, enhanced checksum utility (verify_or_record), CI security-baseline job with non-strict hash check, checksum placeholders wired into Eclipse/VSCode installers, README updated.
[2025-09-15T04:00Z] Phase 3 enhancements: lock-sources script added, SBOM generator now lists manifest packages (CycloneDX), CI strict-mode preview step, README locking workflow documented.
[2025-09-15T04:10Z] Strict checksum enforcement activated: CI now runs validate-sources.sh --strict; README updated with mandatory hash policy.
[2025-09-15T04:20Z] Added archive verification scripts (collect-content-lengths, verify-archives) + CI quick verify workflow.
[2025-09-15T04:25Z] Populated precise Eclipse content_length values & corrected macOS aarch64 size; no mismatches post-fix.
[2025-09-15T04:30Z] Added eclipse release meta entry + release bump script; README updated with Archive Integrity section.
[2025-09-15T04:45Z] Phase 4 kickoff: added append-only ledger (hash chained) scripts/state/ledger.sh.
[2025-09-15T04:50Z] Added rollback stub scripts/state/rollback.sh (npm -g + pip user uninstall prototype).
[2025-09-15T04:55Z] Introduced offline utility scripts/utils/offline.sh with cached fetch abstraction.
[2025-09-15T05:00Z] Implemented prefetch caching scripts/cache/prefetch.sh for eclipse archives.
[2025-09-15T05:05Z] Integrated offline-aware fetch into verify-archives.sh (trans sketched for future generic use).
[2025-09-16T17:15Z] Added manifest cache fingerprint & stale warning (offline.sh) to detect cache drift vs manifest.
[2025-09-16T17:20Z] Enhanced rollback: default dry-run, added brew/apt listing, safer UX; extended help semantics.
[2025-09-16T17:25Z] Generalized prefetch to all archives; skips meta/placeholder hashes; retains filter support.
[2025-09-16T17:30Z] Parallel quick verification implemented (--concurrency) in verify-archives (HEAD size probes multi-process).
[2025-09-16T17:40Z] Introduced structured logging layer: log-json utility + integration in verify-archives, prefetch, ledger record.
[2025-09-16T17:50Z] Metrics summarizer (summarize-logs.sh) added producing counts & basic duration stats from JSONL.
[2025-09-16T17:55Z] Guard workflow quick-guard.yml added (parallel quick verify + ledger integrity) for fast PR feedback.
[2025-09-16T18:00Z] Logging robustness pass: fixed JSON escaping, concurrency logging, duration handling (pending final end-phase ms refinement).

---
## Forward Plan Addendum (Post Archive Integrity)

### Completed (Reclassified)
1. Parallel HEAD probes (verify-archives concurrency).
2. Prefetch/cache skeleton + generalized archive support.
3. Ledger hash chain + rollback stub.
4. Unified JSON logging wrapper (initial slice) integrated into core scripts.

### Immediate (Next Sprint Focus)
1. verify-archives: add `--output-json <file>` summarizing per-artifact status (size_ok, hash_mismatch, etc.).
2. Ensure reliable end-phase log event with precise duration_ms (portable ms helper) and attach artifact counts.
3. Integrate metrics summarizer into CI (artifact upload + threshold gate placeholder).
4. Introduce `scripts/utils/argparse.sh` (central flag parsing; migrate verify-archives first as exemplar).
5. Add `--rebaseline-size <name|all>` to update only `content_length` after intentional upstream repack (hash unchanged) writing manifest patch.
6. Embed manifest hash + original URL inside cache filename sidecar (e.g., `<sha>.meta`) for future drift/trust checks.
7. Drift baseline snapshot generator: produce `baseline/archives.json` (name, sha256, content_length) consumed later by drift detector.

### Near-Term (Phase 5/6 Bridge)
8. Extend logging to course setup scripts (start/end + duration) feeding metrics.
9. Add simple outlier detector (flag installs > configured ms) in summarizer output.
10. Provide ledger verify step in CI guard (separate job) once ledger adoption widens.

### Mid-Term
11. Drift detector cron (compare live HEAD sizes & 304 ETag capture vs baseline).
12. Plugin trust model (allowlist + optional GPG signature placeholder design doc).

### Stretch
13. Container images referencing manifest & cache layering.
14. Upgrade assistant for manifest schema migrations.
15. Security advisory feed placeholder ingestion & alerting integration.

### Deferred / Nice-to-Have Later
16. Rich TUI & remediation generator (Phase 8 scope) – postponed until core observability stable.
17. Performance profiling graph mode (Phase 7) – hold until baseline metrics trending established.

---
## ⏸ Scope Stabilization (September 2025 Freeze)

We are temporarily freezing expansion to advanced phases (6–10) to realign with the original student-focused mission stated in `README.md` and `guide.md`:

Core Mission (from initial docs):
- Fast cross-platform bootstrap (macOS/Linux/Windows+WSL)
- Reliable project quickstarts (Python / Node.js + minimal Java & C++)
- Environment management & health diagnostics
- Backup & recovery workflows
- Basic integrity / safety (checksums for external archives)

Recent work introduced forward-looking platform features (ledger, observability, drift groundwork). These are valuable but now considered "Platform Enhancements" rather than baseline requirements.

### Stabilization Goals (Complete Before Returning to Core Scripts)
1. Verification JSON accuracy: include quick concurrency artifact results (currently empty array) – finish and mark script stable.
2. End-phase metrics: consistent duration_ms + artifact counts (success, fail, skipped) logged & (optionally) exported.
3. Minimal argparse helper (`scripts/utils/argparse.sh`) ONLY for `verify-archives.sh` to reduce flag parsing churn; defer broad migration.
4. Baseline snapshot (`baseline/archives.json`) already generated – wire a simple drift check stub (size/hash mismatch notice, non-fatal) and stop there.
5. Mark experimental components: add headers/comments in `ledger.sh`, `rollback.sh`, `prefetch.sh` noting "EXPERIMENTAL - subject to change".
6. Documentation: Insert a short "Platform Features (Experimental)" section in README pointing to roadmap instead of detailing internals.

After these 6 stabilization items: pause further Phase 5+ build-out and resume improvements to the core setup & course scripts (manifest-driven refactors still outstanding in some areas, plus student usability polish).

### Parked (Will Resume Later)
- Full profile modular system (Phase 6)
- Plugin loader & trust model
- Performance batching & profiling modes (Phase 7)
- Rich TUI / remediation generator (Phase 8)
- Drift detector automation & scheduled jobs (Phase 9)
- Container images & release automation (Phase 10)

### Rationale
This freeze prevents dilution of effort and ensures the observable/security scaffolding does not overshadow the primary educational value: rapid, dependable environment setup for students with clear, concise tooling.

### Exit Criteria for Freeze
- All 6 stabilization goals marked done in changelog snapshot.
- README updated with experimental disclaimer & trimmed advanced detail.
- No open TODOs inside security/state scripts referencing "FIXME for JSON accuracy" or similar.

Once criteria met, create a dated snapshot section here and reopen Phase 6 items in a new "Post-Freeze" subsection.

### Freeze Progress Snapshot
`[2025-09-16T18:30Z]` Stabilization items 1,2,4,5,6 completed:
- (1) Quick concurrency JSON now populated with artifacts.
- (2) End-phase metrics (duration_ms, count) added with portable ms clock.
- (4) Drift baseline + ensure-baseline + drift-check stub integrated (non-fatal in guard workflow).
- (5) Experimental headers added to ledger, rollback, prefetch.
- (6) README experimental section added.
Pending / Deferred intentionally: (3) argparse helper (will implement after returning to core script refactors unless flag parsing churn resumes).
Next action: Resume core manifest-driven refactors & student usability polish; argparse helper tracked but not blocking freeze exit.


```
